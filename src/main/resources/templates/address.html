<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org"
	th:replace="~{/layout/layout::dynamic(~{::body})}">

<head>
<meta charset="UTF-8" />
<title>GreenFarm</title>

</head>

<body>
	<div class="container">
		<div th:each="address : ${addresses}"
			class="card border border-0 rounded-0 mt-3"
			style="padding: 20px; width: auto; border-radius: 3px; background-color: #fff; font-size: 14px; flex-direction: column;">
			<div class="card-header" style="background-color: #fff">
				<span class="form-check"> <input class="form-check-input"
					type="radio" name="flexRadioDefault" id="flexRadioDefault1"
					th:attr="onclick='updateAddressStatus(\'' + ${address.addressID} + '\')'">
					<span class="fw-bold">[[${address.user.firstname}]] |
						[[${address.user.phonenumber}]]</span> <span class="fw-bold float-end">
						<button type="button"
							class="text-danger border-0 bg-white fw-bold"
							data-bs-toggle="modal" data-bs-target="#myModal"
							data-address-id="${address.AddressID}">Cập nhật</button>
				</span>
				</span>
			</div>

			<div class="ms-4">
				<span>[[${address.Street}]],[[${address.District}]],[[${address.City}]]
				</span>
			</div>

		</div>
		<hr>
		<div class="add_address text-danger text-center">
			<i class="bi bi-plus-circle"></i> Thêm mới địa chỉ
		</div>




		<!-- The Modal -->
		<div class="modal" id="myModal">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">

					<!-- Modal Header -->
					<div class="modal-header">
						<h4 class="modal-title">Cập nhật địa chỉ</h4>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>

					<!-- Modal body -->
					<div class="modal-body">

						<form>
							<!-- 2 column grid layout with text inputs for the first and last names -->
							<div class="row ">
								<div class="col">
									<div data-mdb-input-init class="form-outline">
										<label class="form-check-label" for="form2Example33">
											Họ: </label> <input type="text" id="lastname" class="form-control"
											value="[[user.lastname]]" />
									</div>
								</div>
								<div class="col">
									<div data-mdb-input-init class="form-outline">
										<label class="form-check-label" for="form2Example33">
											Tên: </label> <input type="text" id="firstname" class="form-control"
											value="[[user.firstname]]" />

									</div>
								</div>

								<div class="col">
									<div data-mdb-input-init class="form-outline">
										<label class="form-check-label"> Số ĐT: </label> <input
											type="text" id="phonenumber" class="form-control"
											value="[[address.phonenumber]]" />

									</div>
								</div>
							</div>
							<div class="row mt-5">
								<div>
									<select id="city">
										<option value="" selected>Chọn tỉnh thành</option>
									</select> <select id="district">
										<option value="" selected>Chọn quận huyện</option>
									</select> <select id="ward">
										<option value="" selected>Chọn phường xã</option>
									</select>
								</div>
								<div class="col">
									<div data-mdb-input-init class="form-outline">
										<label class="form-check-label" for="form2Example33">
											Đường: </label> <a type="text" class="form-control" id="Street"
											value="[[address.Street]]"></a>

									</div>
								</div>
								<div class="col">
									<div data-mdb-input-init class="form-outline">
										<label class="form-check-label" for="form2Example33">
											Quận: </label> <a type="text" class="form-control" id="District"
											value="[[address.District]]"></a>

									</div>
								</div>

								<div class="col">
									<div data-mdb-input-init class="form-outline">
										<label class="form-check-label"> Tỉnh/Thành phố: </label> <a
											type="text" class="form-control" id="City"
											value="[[address.City]]"></a>

									</div>
								</div>
							</div>
							<div class="float-end mt-3">
								<button type="button" class="btn btn-primary"
									data-bs-dismiss="modal">Trở lại</button>
								<button type="button" class="btn btn-success"
									data-bs-dismiss="modal">Lưu</button>
							</div>
						</form>
					</div>

					<!-- Modal footer -->
					<div class="modal-footer">
						<button type="button" class="btn btn-danger"
							data-bs-dismiss="modal">Đóng</button>
					</div>

				</div>
			</div>
		</div>
	</div>






	<div>



		<p id="a"></p>


		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
			referrerpolicy="no-referrer"></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
		<script>
    const host = "https://provinces.open-api.vn/api/";
var callAPI = (api) => {
    return axios.get(api)
        .then((response) => {
            renderData(response.data, "city");
        });
}
callAPI('https://provinces.open-api.vn/api/?depth=1');
var callApiDistrict = (api) => {
    return axios.get(api)
        .then((response) => {
            renderData(response.data.districts, "district");
        });
}
var callApiWard = (api) => {
    return axios.get(api)
        .then((response) => {
            renderData(response.data.wards, "ward");
        });
}

var renderData = (array, select) => {
    let row = ' <option disable value="">Chọn</option>';
    array.forEach(element => {
        row += `<option data-id="${element.code}" value="${element.name}">${element.name}</option>`
    });
    document.querySelector("#" + select).innerHTML = row
}

$("#city").change(() => {
    callApiDistrict(host + "p/" + $("#city").find(':selected').data('id') + "?depth=2");
    printResultCity();
});
$("#district").change(() => {
    callApiWard(host + "d/" + $("#district").find(':selected').data('id') + "?depth=2");
    printResultDistrict();
});
$("#ward").change(() => {
    printResultStreet();
})



var printResultCity = () => {
    if ($("#district").find(':selected').data('id') != "" && $("#city").find(':selected').data('id') != "" &&
        $("#ward").find(':selected').data('id') != "") {
        let City = $("#city option:selected").text();
        $("#City").text(City)
    }

}

var printResultDistrict = () => {
    if ($("#district").find(':selected').data('id') != "" && $("#city").find(':selected').data('id') != "" &&
        $("#ward").find(':selected').data('id') != "") {
        let District = $("#district option:selected").text() ;
        $("#District").text(District)
    }

}

var printResultStreet = () => {
    if ($("#district").find(':selected').data('id') != "" && $("#city").find(':selected').data('id') != "" &&
        $("#ward").find(':selected').data('id') != "") {
        let Street = $("#ward option:selected").text();
        $("#Street").text(Street)
    }

}



var printResult = () => {
    if ($("#district").find(':selected').data('id') != "" && $("#city").find(':selected').data('id') != "" &&
        $("#ward").find(':selected').data('id') != "") {
        let a = $("#city option:selected").text() +
            " | " + $("#district option:selected").text() + " | " +
            $("#ward option:selected").text();
        $("#a").text(a)
    }

}
	</script>
	</div>



	<script th:inline="javascript">
		function updateAddressStatus(addressId) {
			try {
				$
						.ajax({
							type : 'POST',
							url : '/updateAddressStatus/' + addressId,
							success : function() {
								// Redirect to the checkout page
								window.location.href = '/checkout';
							},
							error : function(xhr, status, error) {
								console.error('Error updating address status:',
										error);

								// Display an error message to the user if needed
								alert('Có lỗi xảy ra khi cập nhật trạng thái địa chỉ.');
							}
						});
			} catch (exception) {
				console.error('Exception in updateAddressStatus:', exception);
			}
		}
	</script>
	<script type="text/javascript">
		// Gửi yêu cầu Ajax để lấy thông tin địa chỉ và người dùng
		function getAddress(addressId) {
			// Tạo đối tượng XMLHttpRequest
			var xhr = new XMLHttpRequest();
			8936079124236
			// Định nghĩa hàm xử lý khi yêu cầu thành công
			xhr.onload = function() {
				if (xhr.status === 200) {
					// Chuyển đổi dữ liệu trả về thành đối tượng JSON
					var response = JSON.parse(xhr.responseText);

					if (response.success) {
						// Hiển thị thông tin địa chỉ và người dùng trong modal
						var address = response.address;
						var user = response.user;

						document.getElementById("firstname").value = user.firstname;
						document.getElementById("lastname").value = user.lastname;
						document.getElementById("phonenumber").value = user.phonenumber;

						document.getElementById("Street").value = address.Street;
						document.getElementById("District").value = address.District;
						document.getElementById("City").value = address.City;
					} else {
						// Xử lý khi có lỗi
						console.error("Error getting address information:",
								response.message);
					}
				} else {
					// Xử lý khi có lỗi
					console.error("Error getting address information. Status:",
							xhr.status);
				}
			};

			// Định nghĩa hàm xử lý khi có lỗi
			xhr.onerror = function() {
				console
						.error("Error getting address information. Network error.");
			};

			// Gửi yêu cầu GET đến URL "/getAddress/{addressId}"
			xhr.open("GET", "/getAddress/" + addressId);
			xhr.send();
		}

		// Gọi hàm getAddress với địa chỉ ID cần lấy thông tin
		var addressId = 123; // Thay thế bằng địa chỉ ID thực tế
		getAddress(addressId);
	</script>
</body>

</html>