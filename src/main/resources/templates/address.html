<!DOCTYPE html>
<html
  xmlns="http://www.thymeleaf.org"
  th:replace="~{/layout/layout::dynamic(~{::body})}"
>
  <head>
    <meta charset="UTF-8" />
    <title>GreenFarm</title>
  </head>

  <body>
    <div class="container">
      <div
        th:each="address : ${addresses}"
        class="card border border-0 rounded-0 mt-3"
        style="
          padding: 20px;
          width: auto;
          border-radius: 3px;
          background-color: #fff;
          font-size: 14px;
          flex-direction: column;
        "
      >
        <div class="card-header" style="background-color: #fff">
          <span class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="flexRadioDefault"
              id="flexRadioDefault1"
              th:attr="onclick='updateAddressStatus(\'' + ${address.addressID} + '\')'"
            />
            <span class="fw-bold"
              >[[${address.fullname}]] |
              [[${address.phonenumber}]]</span
            >
            <span class="fw-bold float-end">
              <button
                type="button"
                class="update-button text-danger border-0 bg-white fw-bold"
                data-bs-toggle="modal"
                data-bs-target="#myModal"
                th:data-address-id="${address.addressID}"
                th:data-address-street="${address.Street}"
                th:data-address-district="${address.District}"
                th:data-address-city="${address.City}"
                th:data-address-firstname="${address.fullname}"
                th:data-user-id="${address.user.userid}"
                th:data-address-phonenumber="${address.phonenumber}"
              >
                Cập nhật
              </button>
            </span>
          </span>
        </div>

        <div class="ms-4">
          <span
            >[[${address.Street}]],[[${address.Ward}]],[[${address.District}]],[[${address.City}]]
          </span>
        </div>
      </div>

      <hr />
      <div class="d-flex w-100">
        <select
          class="form-select form-select-sm mr-3"
          id="city"
          aria-label=".form-select-sm"
        >
          <option value="" selected>Chọn tỉnh thành</option>
        </select>
        <select
          class="form-select form-select-sm mr-3"
          id="district"
          aria-label=".form-select-sm"
        >
          <option value="" selected>Chọn quận huyện</option>
        </select>

        <select
          class="form-select form-select-sm mr-3"
          id="ward"
          aria-label=".form-select-sm"
        >
          <option value="" selected>Chọn phường xã</option>
        </select>
      </div>
      <div class="mt-3 w-100">
        <div class="d-inline-grid mr-3 w-75">
          <label>Địa chỉ: </label> <input type="text"/>
        </div>
        <div class="d-inline-grid">
          <label>Số điện thoại</label> <input type="number" placeholder="" />
        </div>
      </div>
      <hr />
      <div class="add_address text-danger text-center">
        <i class="bi bi-plus-circle"></i> Thêm mới địa chỉ
      </div>

      <!-- The Modal -->
      <div
        class="modal fade"
        id="myModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="myModalLabel"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Cập nhật địa chỉ</h4>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
              <!-- Thêm các trường input cho dữ liệu -->
              <input type="text" id="addressId" />
              <input type="text" id="userid" />
              <input type="text" id="street" class="form-control" />
              <input type="text" id="" class="form-control" />
              <input type="text" id="" class="form-control" />
              <input type="text" id="firstname" class="form-control" />
              <input type="text" id="phonenumber" class="form-control" />
            </div>
			

            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" id="updateAddress">
                Cập nhật
              </button>

              <button
                type="button"
                class="btn btn-danger"
                data-bs-dismiss="modal"
              >
                Đóng
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      function updateAddressStatus(addressId) {
        try {
          $.ajax({
            type: "POST",
            url: "/updateAddressStatus/" + addressId,
            success: function () {
              // Redirect to the checkout page
              window.location.href = "/checkout";
            },
            error: function (xhr, status, error) {
              console.error("Error updating address status:", error);

              // Display an error message to the user if needed
              alert("Có lỗi xảy ra khi cập nhật trạng thái địa chỉ.");
            },
          });
        } catch (exception) {
          console.error("Exception in updateAddressStatus:", exception);
        }
      }
    </script>

    <script th:inline="javascript">
      $(document).ready(function () {
        $(".update-button").on("click", function () {
          var addressId = parseInt($(this).data("address-id"));
          var userid = parseInt($(this).data("user-id"));
          var street = $(this).data("address-street");
          var district = $(this).data("address-district");
          var city = $(this).data("address-city");
          var firstname = $(this).data("address-firstname");
          var phonenumber = $(this).data("address-phonenumber");

          // Đẩy dữ liệu lên modal
          $("#myModal #addressId").val(parseInt(addressId));
          $("#myModal #userid").val(parseInt(userid));
          $("#myModal #street").val(street);
          $("#myModal #district").val(district);
          $("#myModal #city").val(city);
          $("#myModal #firstname").val(firstname);
          $("#myModal #phonenumber").val(phonenumber);
        });
      });
    </script>
    <script th:inline="javascript">
      $(document).ready(function () {
        $("#updateAddress").on("click", function () {
          var addressId = $("#addressId").val();
          var street = $("#street").val();
          var district = $("#district").val();
          var city = $("#city").val();
          var userid = parseInt($("#userid").val());

          var updateData = {
            street: street,
            district: district,
            city: city,
            user: { userid: userid },
          };

          // Gửi yêu cầu cập nhật đến server
          $.ajax({
            type: "PUT",
            url: "/rest/addresses/update/" + addressId,
            contentType: "application/json",
            data: JSON.stringify(updateData),
            success: function (response) {
              // Xử lý phản hồi thành công
              console.log(response);
              // Đóng modal sau khi cập nhật thành công
              $("#myModal").modal("hide");
            },
            error: function (error) {
              // Xử lý lỗi
              console.error(error);
            },
          });
        });
      });
    </script>
  </body>
</html>
