<!DOCTYPE html>
<html th:xmlns="http://www.thymeleaf.org" th:replace="~{/layout/layout::dynamic(~{::body})}">

<head>
	<meta charset="UTF-8" />
	<title>GreenFarm</title>

	<style>
		.alert-danger {
			color: red;
			font-size: 0.8rem;
			margin-top: 0.5rem;
		}
	</style>
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

</head>

<body>
	<div class="container shop-detail">
		<div class="pt-3">
			<div th:object="${item}" class="row">
				<nav aria-label="breadcrumb">
					<ol class="breadcrumb" style="background-color: white;">
						<li style="color: #0055AA;" class="breadcrumb-item"><a href="#"
								th:text="#{shopDetail.label.breadcrumbHome}">Trang
								chủ</a></li>
						<li style="color: #0055AA;" class="breadcrumb-item"><a href="#"
								th:text="#{shopDetail.label.breadcrumbShop}">Shop</a></li>
						<li class="breadcrumb-item active" aria-current="page" th:text="*{productname}"></li>
					</ol>
				</nav>
				<div class="col-lg-6 border-1">
					<img id="mainImage" th:src="@{|*{image}|}" alt="" style="width: 100%; height: 400px;">

					<div class="tab-content produc_tab_c mt-2">
						<div class="tab-pane fade show active" role="tabpanel">
							<div class="modal_img row justify-content-center">
								<div th:each="productImage: ${item.productimage}"
									class="col-md-2 justify-content-center">
									<a href="" class="d-block"> <img class="thumbnail-image"
											th:src="${productImage.imageurl}" alt=""
											style="width: 80px; height: 80px" />
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-lg-6 product-details">
					<div class="text-left mb-3 pb-3">
						<h3 th:text="*{productname}" class="text-uppercase mt-3"></h3>
						<h2 class="mb-3" style="font-weight: 300; color: #80bb01; font-size: 28px">
							<!--<span th:text="*{#numbers.formatDecimal(price, 0, 'COMMA', 0, 'POINT')} + 'đ'"
								style="color: #999; text-decoration: line-through"></span>-->
							<span th:text="*{#numbers.formatDecimal(price,0,'COMMA',0,'POINT')} + ' ₫ '"></span>
						</h2>
						<p th:text="*{description}" class="product-description mb-3"></p>
						Số Lượng : <span th:text="*{quantityavailable}" class="product-description mb-3"></span> sản
						phẩm có sẵn

						<div class="cart-button mt-5 mb-5 d-flex">
							<div class="d-flex">
								<button style="border: 1px solid rgba(0, 0, 0, .09); width: 32px"
									onclick="decQuantity()">-</button>
								<input style="border: 1px solid rgba(0, 0, 0, .09);" class="w-25 text-center"
									type="text" id="quantityInput" name="quantity" value="1" min="1" />
								<button style="border: 1px solid rgba(0, 0, 0, .09); width: 32px"
									onclick="incQuantity()">+</button>
							</div>

							<button th:if="${item.quantityavailable > 0}" style="background-color: #7AB730"
								class="add-to-cart-button" th:onclick="'addToCart(\'' + ${item.productid} + '\')'"
								th:text="#{shopDetail.label.addToCart}">
								<i class="fas fa-shopping-cart"></i> Add to Cart
							</button>
							<button th:if="${item.quantityavailable <= 0}"
								style="background-color: #7AB730; color: white; text-decoration: none; cursor: not-allowed;"
								class="add-to-cart-button">
								<i class="fas fa-exclamation-circle"></i> Sản phẩm đã hết hàng
							</button>

							<!-- <a th:if="${item.quantityavailable <= 0}"
								style="background-color: #7AB730; color: white; text-decoration: none; cursor: not-allowed;"
								href="#"> <i class="fas fa-exclamation-circle"></i> Liên hệ
							</a> -->
						</div>
						<div class="">
							<h5>
								<span th:text="#{shopDetail.label.category}">CATEGORIES :
								</span> <span><a th:text="*{category.categoryname}" /></span>
							</h5>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="wapper">
			<div class="">
				<h1 class="py-3" th:text="#{shopDetail.label.relatedProduct}">SẢN
					PHẨM LIÊN QUAN</h1>
			</div>
			<div class="row slider" th:object="${item}">
				<div class="col-md-12 col-sm-12 col-xs-12 slide" th:each="p : *{category.products}">
					<div class="wap-items-ss brbox">
						<a th:href="@{|/product/detail/${p.productid}|}" class="wap-ss-img"> <img
								th:src="@{|${p.image}|}" alt="Product Image" style="width: 270px;">
						</a>
						<div class="textleft">
							<a th:href="@{|/product/detail/${p.productid}|}" th:text="${p.productname}"
								style="color: black; text-decoration: none;"></a>
							<div>
								<b th:text="${#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT')} + ' ₫ '"></b>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<br>



		<div class=" mb-3">
			<h1 th:text="#{shopDetail.label.productReviews}">ĐÁNH GIÁ SẢN
				PHẨM</h1>
		</div>
		<div class="row ">
			<div class="col-12 text-center">
				<div class="card">
					<div class="row justify-content-left d-flex">

						<!-- <div class="col-md-5">
							<h1 class="pt-4">Tỷ lệ đánh giá</h1>
							<div class="rating-bar0 justify-content-center">
								<table class="text-left mx-auto">
									<tr>
										<td class="rating-label"><i class="fas fa-star text-warning"></i> 5</td>
										<td class="rating-bar">
											<div class="bar-container">
												<div class="bar-5"></div>
											</div>
										</td>
										<td class="text-right">123</td>
									</tr>
									<tr>
										<td class="rating-label"><i class="fas fa-star text-warning"></i> 4</td>
										<td class="rating-bar">
											<div class="bar-container">
												<div class="bar-4"></div>
											</div>
										</td>
										<td class="text-right">23</td>
									</tr>
									<tr>
										<td class="rating-label"><i class="fas fa-star text-warning"></i> 3</td>
										<td class="rating-bar">
											<div class="bar-container">
												<div class="bar-3"></div>
											</div>
										</td>
										<td class="text-right">10</td>
									</tr>
									<tr>
										<td class="rating-label"><i class="fas fa-star text-warning"></i> 2</td>
										<td class="rating-bar">
											<div class="bar-container">
												<div class="bar-2"></div>
											</div>
										</td>
										<td class="text-right">3</td>
									</tr>
									<tr>
										<td class="rating-label"><i class="fas fa-star text-warning"></i> 1</td>
										<td class="rating-bar">
											<div class="bar-container">
												<div class="bar-1"></div>
											</div>
										</td>
										<td class="text-right">0</td>
									</tr>
								</table>
							</div>
						</div> -->
						<div class="col-md-12">
							<div class="card">
								<div class="modal-header">
									<h1 class="modal-title fs-6 text-center" id="exampleModalLabel"
										th:text="#{shopDetail.label.thanhks}">GreenFarm xin được
										cám ơn quý khách!</h1>
								</div>
								<div class="card-body">
									<form th:action="@{'/product/detail/' + ${productid}}" th:object="${reviewinsert}"
										method="post" onsubmit="return confirmSubmit()">
										<fieldset style="font-size: 40px;" class="rating" th:field="*{rating}">
											<input type="radio" id="star5" name="rating" value="5" /><label class="full"
												for="star5"></label> <input type="radio" id="star4" name="rating"
												value="4" /><label class="full" for="star4"></label> <input type="radio"
												id="star3" name="rating" value="3" /><label class="full"
												for="star3"></label>
											<input type="radio" id="star2" name="rating" value="2" /><label class="full"
												for="star2"></label> <input type="radio" id="star1" name="rating"
												value="1" /><label class="full" for="star1"></label>
										</fieldset>

										<div class="form-outline">
											<textarea th:field="*{content}" class="form-control" id="textAreaExample"
												rows="4"></textarea>
										</div>

										<div class="d-flex justify-content-between mt-3">
											<button type="submit" class="btn btn-danger"
												th:text="#{shopDetail.label.sendReviews}">
												Gửi đánh giá <i id="review-button"
													class="fas fa-long-arrow-alt-right ms-1"></i>
											</button>

										</div>

									</form>
								</div>
							</div>
						</div>
					</div>

				</div>

			</div>


			<div id="review-section" class="col-12">
				<div th:each="review : ${review}" class="cardrating">
					<div class="row ">
						<div class="col-md-6">
							<img style="width: 50px; height: 50px" class="profile-pic"
								th:src="@{|${review.user.image}|}" alt="User Image" th:text="${review.user.email}" />

						</div>

						<div class="col-md-6" th:if="${#authorization.expression('isAuthenticated')}">
							<script th:inline="javascript">
								/*<![CDATA[*/
								var hasUserReviewedProductValue = /*[[${#authorization.expression(review.user.email == #authentication.principal.username)}]]*/ false;
								var hasUserReviewedProduct = (hasUserReviewedProductValue !== null) ? hasUserReviewedProductValue : false;
        /*]]>*/
							</script>

							<button onclick="confirmDeleteReview(event)" style="float: right;" class="btn btn-danger"
								th:if="${#authorization.expression(review.user.email == #authentication.principal.username)}">
								<a th:href="@{'/product/detail/' + ${productid} + '/delete/' + ${review.reviewid}}"
									th:text="#{shopDetail.label.delete}">Xóa</a>
							</button>
						</div>


						<div class=" d-flex flex-column">
							<div>
								<span class="fa fa-star star-active"
									th:each="i : ${#numbers.sequence(1, review.rating)}"></span> <span
									class="fa fa-star-half star-active" th:if="${review.rating % 1 != 0}"></span> <span
									th:if="${review.rating != 5}"> <span class="fa fa-star star-inactive"
										th:each="i : ${#numbers.sequence(review.rating.floatValue() +1,5)}">
									</span>
								</span>

							</div>
							<div>
								<span th:text="${review.product.category.categoryname}"></span>
								| <span th:text="${review.datepost}" class=""></span>
							</div>

						</div>
					</div>
					<div class="row text-left">
						<p style="font-family: Arial, Helvetica, sans-serif" class="content"
							th:text="${review.content}"></p>
					</div>

				</div>
				<!--<div class="panel-footer text-center py-3">
					<span class="col-md-6"
						style="text-align: right; font-weight: bold; color: black; font-size: 15px;"></span>
					<button ng-click="pager.first()" class="btn btn-success" style="background-color: #7AB730">
						<i class="fas fa-angle-double-left"></i>
					</button>
					<button ng-click="pager.prev()" class="btn btn-success" style="background-color: #7AB730">
						<i class="fas fa-angle-left"></i>
					</button>
					<button ng-click="pager.next()" class="btn btn-success" style="background-color: #7AB730">
						<i class="fas fa-angle-right"></i>
					</button>
					<button ng-click="pager.last()" class="btn btn-success" style="background-color: #7AB730">
						<i class="fas fa-angle-double-right"></i>
					</button>

				</div>-->

				<div th:if="${review.totalPages > 1}" class="pagination justify-content-center">
					<ul class="pagination justify-content-center">
						<li th:class="${review.number == 0} ? 'page-item disabled' : 'page-item'">
							<a th:href="@{${url}(page=0)}" class="page-link"><i
									class="bi bi-chevron-double-left"></i></a>
						</li>
						<li th:class="${review.number == 0} ? 'page-item disabled' : 'page-item'">
							<a th:href="@{${url}(page=${review.number - 1})}" class="page-link"><i
									class="bi bi-chevron-left"></i></a>
						</li>
						<li th:each="pageNumber : ${#numbers.sequence(0, review.totalPages - 1)}"
							th:class="${review.number == pageNumber} ? 'page-item active' : 'page-item'">
							<a th:href="@{${url}(page=${pageNumber})}" class="page-link"
								th:text="${pageNumber + 1}"></a>
						</li>
						<li th:class="${review.number == review.totalPages - 1} ? 'page-item disabled' : 'page-item'">
							<a th:href="@{${url}(page=${review.number + 1})}" class="page-link"><i
									class="bi bi-chevron-right"></i></a>
						</li>
						<li th:class="${review.number == review.totalPages - 1} ? 'page-item disabled' : 'page-item'">
							<a th:href="@{${url}(page=${review.totalPages - 1})}" class="page-link"><i
									class="bi bi-chevron-double-right"></i></a>
						</li>
					</ul>
				</div>

			</div>

		</div>
	</div>


	<script>
		$(document).ready(function () {
			$(".thumbnail-image").on("click", function (e) {
				e.preventDefault();

				// Xóa lớp "selected" từ tất cả các hình ảnh
				$(".thumbnail-image").removeClass("selected");

				// Thêm lớp "selected" cho hình ảnh được chọn
				$(this).addClass("selected");

				// Lấy đường dẫn hình ảnh từ thuộc tính data-imageurl
				var newImageUrl = $(this).attr("src");

				// Thay đổi thuộc tính src của hình chính
				$("#mainImage").attr("src", newImageUrl);
			});
		});

		function incQuantity() {
			var quantityInput = document.getElementById('quantityInput');
			var currentQuantity = parseInt(quantityInput.value);
			if (!isNaN(currentQuantity)) {
				quantityInput.value = currentQuantity + 1;
			}
		}

		function decQuantity() {
			var quantityInput = document.getElementById('quantityInput');
			var currentQuantity = parseInt(quantityInput.value);
			if (!isNaN(currentQuantity) && currentQuantity > 1) {
				quantityInput.value = currentQuantity - 1;
			}
		}
	</script>
	<script th:inline="javascript">
		function addToCartAndRedirect(productId) {
			addToCart(productId);

			// Redirect to the "/cart" page
			window.location.href = '/cart';
		};
		function addToCartAndDisplayModal(productId) {
			// Call your existing addToCart function (assuming it's already defined)
			addToCart(productId);

			// Display the modal
			$('#addToCartModal').modal('show');

			// Automatically close the modal after 2 seconds (adjust as needed)
			setTimeout(function () {
				$('#addToCartModal').modal('hide');
			}, 2000);
		}
	</script>

	<script th:inline="javascript">
		function confirmDeleteReview(event) {
			event.preventDefault(); // Ngăn chặn sự kiện mặc định của thẻ 'a'

			Swal.fire({
				title: 'Xác nhận xóa đánh giá?',
				text: 'Bạn có chắc chắn muốn xóa đánh giá này không?',
				icon: 'question',
				showCancelButton: true,
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33',
				confirmButtonText: 'Đồng ý',
				cancelButtonText: 'Hủy bỏ',
			}).then((result) => {
				if (result.isConfirmed) {
					// Nếu người dùng chọn "Đồng ý", thực hiện chuyển hướng
					window.location.href = event.target.getAttribute('href');
				}
			});
		}

	</script>

	<script th:inline="javascript">

		// Chuyển đổi giá trị từ chuỗi sang boolean (nếu cần)
		console.log("hasUserReviewedProduct: " + hasUserReviewedProduct);

		function confirmSubmit() {

			if (hasUserReviewedProduct) {
				// If the user has already reviewed, show a different modal
				Swal.fire({
					title: 'Đánh giá đã tồn tại!',
					text: 'Bạn đã đánh giá sản phẩm này rồi.',
					icon: 'warning',
					confirmButtonColor: '#3085d6',
					confirmButtonText: 'OK'
				}).then(() => {
					// Reload the form after clicking OK
					location.reload();
				});
			} else {
				// If the user hasn't reviewed, show the confirmation modal
				Swal.fire({
					title: 'Xác nhận gửi đánh giá?',
					text: 'Bạn có chắc muốn gửi đánh giá?',
					icon: 'question',
					showCancelButton: true,
					confirmButtonColor: '#3085d6',
					cancelButtonColor: '#d33',
					confirmButtonText: 'Đồng ý',
					cancelButtonText: 'Hủy bỏ'
				}).then((result) => {
					if (result.isConfirmed) {
						// If the user confirms, show a success modal and submit the form
						Swal.fire({
							title: 'Đánh giá đã lưu thành công!',
							text: 'Cảm ơn bạn đã đánh giá sản phẩm.',
							icon: 'success',
							showCancelButton: false,
							confirmButtonColor: '#3085d6',
							confirmButtonText: 'OK'
						}).then(() => {
							// If the user clicks OK, submit the form
							document.querySelector('form').submit();
						});
					}
				});
			}

			return false; // Ngăn chặn hành động mặc định của form
		}
	</script>

</body>

</html>